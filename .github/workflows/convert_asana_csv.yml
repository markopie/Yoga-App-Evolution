name: Convert Asana JSON to CSV
on:
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Pre-process JSON with jq
        run: |
          # Create the clean JSON array
          jq -c 'to_entries | map({id: .key, name: .value.name, note: .value.note})' asana_library.json > processed.json
          
          # Read the file into a GitHub Environment variable safely
          echo "CLEAN_JSON<<EOF" >> $GITHUB_ENV
          cat processed.json >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Convert JSON to CSV
        uses: austenstone/json-to-csv@main
        id: csv_step
        with:
          # Now passing the actual content of the file
          json: ${{ env.CLEAN_JSON }}

      - name: Create CSV File
        run: |
          echo "${{ steps.csv_step.outputs.csv }}" > asana_tasks.csv

      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: asana-csv-export
          path: asana_tasks.csv
